{% extends "base.html" %}

{% block content %}

<style>
/* ===============================
   Card and Input Styling (Dark Theme)
   =============================== */

/* Form styling */
.card {
    background: #1e1e1e;
    padding: 2rem;
    border-radius: 10px;
    color: white;
}

input {
    width: 100%;
    padding: 0.65rem;
    margin-top: 0.3rem;
    border-radius: 6px;
    border: 1px solid #444;
    background-color: #121212;
    color: #ffffff;
}

input:focus {
    outline: none;
    border-color: #007bff;
}

label {
    margin-top: 1rem;
    display: block;
    font-size: 0.9rem;
    color: #cccccc;
}

/* ===============================
   Upgraded: Segment Control Styling (For Role Selection)
   =============================== */
.segment-control {
    display: flex;
    border: 1px solid #444; /* Match card border color */
    border-radius: 6px;
    overflow: hidden; /* Important for border-radius */
    margin-top: 0.3rem;
}

.segment-control input[type="radio"] {
    display: none; /* Hide the actual radio button */
}

.segment-control label {
    flex: 1;
    text-align: center;
    padding: 0.65rem 0.5rem;
    cursor: pointer;
    background-color: #121212; /* Default background (unselected) */
    color: #cccccc; /* Default text color */
    border-right: 1px solid #444; /* Separator */
    margin-top: 0; /* Override existing label margin */
    transition: background-color 0.2s, color 0.2s;
    font-size: 0.9rem; /* Match other labels */
}

.segment-control label:last-child {
    border-right: none; /* No separator on the last item */
}

/* Hover effect */
.segment-control label:hover {
    background-color: #2a2a2a;
}

/* Active/Selected State */
.segment-control input[type="radio"]:checked + label {
    background-color: #007bff; /* Primary selection color */
    color: white; /* White text on active background */
    font-weight: bold;
}

/* ===============================
   Button Styling
   =============================== */
.btn-primary {
    margin-top: 1.5rem;
    padding: 0.75rem;
    background-color: #28a745;
    width: 100%;
    border: none;
    color: white;
    font-size: 1.1rem;
    border-radius: 6px;
}

.btn-primary:hover {
    background-color: #218838;
}
</style>

<div class="card" style="max-width: 500px; margin: 2rem auto;">
    <h2 style="text-align: center; margin-bottom: 2rem;">Register</h2>

    <form method="POST">

        <label style="margin-bottom: 0.5rem;">Role</label>
        <div class="segment-control">
            <input aria-label="Role patient" type="radio" id="role-patient" name="role" value="patient" required {% if pre_role == 'patient' %}checked{% endif %}>
            <label for="role-patient">Patient</label>

            <input aria-label="Role doctor" type="radio" id="role-doctor" name="role" value="doctor" required {% if pre_role == 'doctor' %}checked{% endif %}>
            <label for="role-doctor">Doctor</label>
        </div>

    <label for="name">Full Name</label>
    <input aria-label="Full name" type="text" id="name" name="name" required value="{{ pre_name|default('') }}">

    <label for="username">Username</label>
    <input aria-label="Username" type="text" id="username" name="username" required value="{{ pre_username|default('') }}">

        <label for="password">Password</label>
        <input 
            aria-label="Password"
            type="password" 
            id="password" 
            name="password" 
            required
            pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}"
            title="Password must contain at least 8 characters, including uppercase, lowercase, number, and special character."
        >

        <div id="pw-strength" style="margin-top:0.5rem;">
            <div id="strength-bar" style="height:8px;background:#e5e7eb;border-radius:6px;overflow:hidden;">
                <div id="strength-fill" style="height:100%;width:0%;background:#f87171;transition:width 150ms ease"></div>
            </div>
            <small id="strength-text" style="display:block;margin-top:0.35rem;color:#cccccc;">Enter a strong password</small>
        </div>

        <button type="submit" id="register-submit" class="btn-primary" disabled>Register</button>
    </form>

    <p style="text-align: center; margin-top: 1.5rem;">
        Already have an account?  
        <a href="/login" style="color: #00aaff;">Login here</a>
    </p>
</div>

<script>
// Client-side password strength checking to improve UX. Server still enforces rules.
(() => {
    const pw = document.getElementById('password');
    const uname = document.getElementById('username');
    const submit = document.getElementById('register-submit');
    const fill = document.getElementById('strength-fill');
    const text = document.getElementById('strength-text');

    const common = new Set(["password","123456","12345678","qwerty","abc123","letmein","monkey","dragon","111111","1234567"]);

    function evaluate(pwVal, usernameVal) {
        if (!pwVal) return {score: 0, strong: false, msg: 'Enter a password'};

        let score = 0;
        if (pwVal.length >= 8) score += 1;
        if (pwVal.length >= 12) score += 1;
        if (/[a-z]/.test(pwVal)) score += 1;
        if (/[A-Z]/.test(pwVal)) score += 1;
        if (/\d/.test(pwVal)) score += 1;
        if (/[@$!%*?&^#()_+\-={}:;<>.,]/.test(pwVal)) score += 1;
        if (usernameVal && usernameVal.trim() && pwVal.toLowerCase().includes(usernameVal.trim().toLowerCase())) {
            return {score: 0, strong: false, msg: 'Password must not contain username.'};
        }
        if (common.has(pwVal.toLowerCase())) {
            return {score: 0, strong: false, msg: 'Password is too common.'};
        }

        const pct = Math.min(100, Math.round((score / 6) * 100));
        const strong = (score >= 5);
        let msg = strong ? 'Strong password' : 'Weak password â€” include uppercase, lowercase, number and special char.';
        if (pwVal.length < 8) msg = 'Password must be at least 8 characters.';

        return {score: pct, strong: strong, msg: msg};
    }

    function refresh() {
        const result = evaluate(pw.value || '', uname.value || '');
        fill.style.width = result.score + '%';
        if (result.score < 40) fill.style.background = '#f87171';
        else if (result.score < 75) fill.style.background = '#f59e0b';
        else fill.style.background = '#10b981';
        text.textContent = result.msg;
        submit.disabled = !result.strong;
    }

    if (pw) pw.addEventListener('input', refresh);
    if (uname) uname.addEventListener('input', refresh);

    // Run on load to handle pre-filled username when server re-renders the form
    window.addEventListener('load', function(){ setTimeout(refresh, 50); });
})();
</script>

{% endblock %}